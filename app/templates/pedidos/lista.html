{% extends 'base.html' %}

{% block content %}
<h1>Lista de Pedidos de Doação</h1>

<!-- Filtros -->
<form method="GET" action="{{ url_for('listar_pedidos') }}" class="mb-3">
  <div class="form-row" style="display:flex;flex-wrap:wrap;gap:10px;">
    <div class="form-group" style="min-width:220px;flex:1;">
      <label for="search_pessoa">Pessoa</label>
      <input
        type="text"
        id="search_pessoa"
        name="search_pessoa"
        class="form-control"
        placeholder="Buscar por pessoa..."
        value="{{ request.args.get('search_pessoa', '') }}"
      >
    </div>

    <div class="form-group" style="min-width:220px;flex:1;">
      <label for="search_produto">Produto</label>
      <input
        type="text"
        id="search_produto"
        name="search_produto"
        class="form-control"
        placeholder="Buscar por produto..."
        value="{{ request.args.get('search_produto', '') }}"
      >
    </div>

    <div class="form-group" style="min-width:180px;">
      <label for="data_inicial">Data Inicial</label>
      <input
        type="date"
        id="data_inicial"
        name="data_inicial"
        class="form-control"
        value="{{ request.args.get('data_inicial', '') }}"
      >
    </div>

    <div class="form-group" style="min-width:180px;">
      <label for="data_final">Data Final</label>
      <input
        type="date"
        id="data_final"
        name="data_final"
        class="form-control"
        value="{{ request.args.get('data_final', '') }}"
      >
    </div>

    <div class="form-group" style="min-width:220px;">
      <label for="order_by">Ordenar por</label>
      <select id="order_by" name="order_by" class="form-control">
        {% set ob = request.args.get('order_by','data_desc') %}
        <option value="data_desc"   {{ 'selected' if ob=='data_desc' else '' }}>Data (mais recente)</option>
        <option value="data_asc"    {{ 'selected' if ob=='data_asc' else '' }}>Data (mais antiga)</option>
        <option value="pessoa_asc"  {{ 'selected' if ob=='pessoa_asc' else '' }}>Pessoa (A→Z)</option>
        <option value="pessoa_desc" {{ 'selected' if ob=='pessoa_desc' else '' }}>Pessoa (Z→A)</option>
        <option value="produto_asc" {{ 'selected' if ob=='produto_asc' else '' }}>Produto (A→Z)</option>
        <option value="produto_desc"{{ 'selected' if ob=='produto_desc' else '' }}>Produto (Z→A)</option>
      </select>
    </div>

    <div class="form-group" style="align-self:flex-end;">
      <button type="submit" class="btn btn-primary">Filtrar</button>
      {% if request.args %}
        <a href="{{ url_for('listar_pedidos') }}" class="btn btn-secondary ml-1">Limpar</a>
      {% endif %}
    </div>
  </div>
</form>

<!-- Botão para gerar PDF (mantém os filtros atuais) -->
<form method="GET" action="{{ url_for('relatorio_pedidos_pdf') }}" class="mb-3">
  <input type="hidden" name="search_pessoa" value="{{ request.args.get('search_pessoa', '') }}">
  <input type="hidden" name="search_produto" value="{{ request.args.get('search_produto', '') }}">
  <input type="hidden" name="data_inicial" value="{{ request.args.get('data_inicial', '') }}">
  <input type="hidden" name="data_final" value="{{ request.args.get('data_final', '') }}">
  <input type="hidden" name="order_by" value="{{ request.args.get('order_by', 'data_desc') }}">
  <button type="submit" class="btn btn-success">Gerar PDF</button>
</form>

<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome da Pessoa</th>
      <th>Produto</th>
      <th>Quantidade</th>
      <th>Data</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for pedido in pedidos %}
    <tr>
      <td>{{ pedido.id }}</td>
      <td>{{ pedido.pessoa.nome }}</td>
      <td>{{ pedido.produto.nome_produto }}</td>
      <td>{{ pedido.quantidade }}</td>
      <td>{{ pedido.data_pedido.strftime('%d/%m/%Y') }}</td>
      <td>
        <a
          href="{{ url_for('validar_pedido', pessoa_id=pedido.pessoa.id, produto_id=pedido.produto.id, quantidade=pedido.quantidade) }}"
          class="btn btn-success"
        >
          Atender Pedido
        </a>
        <form action="{{ url_for('delete_pedido', id=pedido.id) }}" method="post" style="display:inline;">
          <button type="submit" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja excluir este pedido?')">X</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

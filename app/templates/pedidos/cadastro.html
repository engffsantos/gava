{% extends 'base.html' %}
{% block content %}
<h2>Cadastrar Pedido de Doação</h2>

<form method="POST" id="form-pedido">
  <!-- Pessoa: busca com autocomplete -->
  <div class="mb-3 position-relative">
    <label for="pessoa_busca" class="form-label">Pessoa</label>
    <input
      type="text"
      class="form-control"
      id="pessoa_busca"
      placeholder="Digite nome, telefone ou bairro..."
      autocomplete="off"
      required
    >
    <!-- Campo oculto com o ID selecionado (é isso que será enviado) -->
    <input type="hidden" name="pessoa_id" id="pessoa_id" required>

    <!-- Dropdown de sugestões -->
    <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 260px; overflow:auto; display:none;"></div>
    <div class="form-text">Selecione um item da lista para definir a pessoa corretamente.</div>
  </div>

  <!-- Produto -->
  <div class="mb-3">
    <label for="produto_id" class="form-label">Produtos</label>
    <select class="form-control" id="produto_id" name="produto_id" required>
      {% for produto in produtos %}
      <option value="{{ produto.id }}">{{ produto.nome_produto }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Quantidade -->
  <div class="mb-3">
    <label for="quantidade" class="form-label">Quantidade</label>
    <input type="number" class="form-control" id="quantidade" name="quantidade" min="1" required>
  </div>

  <button type="submit" class="btn btn-primary">Cadastrar Pedido</button>
</form>

<script>
(function() {
  const input = document.getElementById('pessoa_busca');
  const hiddenId = document.getElementById('pessoa_id');
  const box = document.getElementById('suggestions');
  let timer = null;
  let lastQuery = '';
  let selectedIdx = -1;

  function debounce(fn, ms) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(fn, ms);
  }

  function render(items) {
    box.innerHTML = '';
    selectedIdx = -1;
    if (!items || !items.length) {
      box.style.display = 'none';
      return;
    }
    items.forEach((p, i) => {
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'list-group-item list-group-item-action';
      el.dataset.id = p.id;
      el.dataset.nome = p.nome;
      el.innerHTML = `
        <div><strong>${p.nome}</strong> ${p.ativo ? '' : '<span class="badge bg-secondary">inativo</span>'}</div>
        <small>${p.bairro ? 'Bairro: ' + p.bairro + ' · ' : ''}${p.telefone ? 'Tel: ' + p.telefone : ''}</small>
      `;
      el.addEventListener('click', () => selectPessoa(p));
      box.appendChild(el);
    });
    box.style.display = 'block';
  }

  function selectPessoa(p) {
    input.value = p.nome;
    hiddenId.value = p.id;
    box.style.display = 'none';
  }

  async function search(q) {
    if (!q || q.length < 2) {
      box.style.display = 'none';
      return;
    }
    if (q === lastQuery) return;
    lastQuery = q;
    try {
      const resp = await fetch(`/pessoas/busca?q=${encodeURIComponent(q)}`);
      if (!resp.ok) throw new Error('Falha ao buscar pessoas');
      const data = await resp.json();
      render(data);
    } catch (e) {
      console.error(e);
      box.style.display = 'none';
    }
  }

  input.addEventListener('input', () => {
    hiddenId.value = ''; // limpamos o ID quando o texto muda
    debounce(() => search(input.value.trim()), 250);
  });

  // Teclado (setas/enter)
  input.addEventListener('keydown', (e) => {
    const items = Array.from(box.querySelectorAll('.list-group-item'));
    if (!items.length || box.style.display === 'none') return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIdx = (selectedIdx + 1) % items.length;
      items.forEach((el, i) => el.classList.toggle('active', i === selectedIdx));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIdx = (selectedIdx - 1 + items.length) % items.length;
      items.forEach((el, i) => el.classList.toggle('active', i === selectedIdx));
    } else if (e.key === 'Enter') {
      if (selectedIdx >= 0) {
        e.preventDefault();
        const el = items[selectedIdx];
        selectPessoa({
          id: el.dataset.id,
          nome: el.dataset.nome
        });
      }
    } else if (e.key === 'Escape') {
      box.style.display = 'none';
    }
  });

  // Fecha a lista ao clicar fora
  document.addEventListener('click', (e) => {
    if (!box.contains(e.target) && e.target !== input) {
      box.style.display = 'none';
    }
  });

  // Validação: exige pessoa_id preenchido
  document.getElementById('form-pedido').addEventListener('submit', (e) => {
    if (!hiddenId.value) {
      e.preventDefault();
      alert('Selecione uma pessoa da lista para continuar.');
      input.focus();
    }
  });
})();
</script>
{% endblock %}
